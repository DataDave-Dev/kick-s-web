---
// filepath: c:\Users\SISTEMAS\proyectos\kick's-web\src\components\Header.astro
import { supabase } from "../lib/supabase";

const currentUrl = Astro.url.pathname;
const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

let isLoggedIn = false;

if (accessToken && refreshToken) {
    try {
        const session = await supabase.auth.setSession({
            refresh_token: refreshToken.value,
            access_token: accessToken.value,
        });
        if (!session.error && session.data.user) {
            isLoggedIn = true;
        } else {
            Astro.cookies.delete("sb-access-token", { path: "/" });
            Astro.cookies.delete("sb-refresh-token", { path: "/" });
        }
    } catch (error) {
        Astro.cookies.delete("sb-access-token", { path: "/" });
        Astro.cookies.delete("sb-refresh-token", { path: "/" });
    }
}
---

<header
    class="fixed z-10 bg-white w-full flex flex-row justify-between items-center px-4 md:px-12 py-4 shadow-md"
>
    <h1 class="text-lg md:text-xl font-bold">
        <a href="/" aria-label="Inicio">
            Kick's <span class="text-red-500">Store</span>
        </a>
    </h1>

    <nav class="flex">
        <ul class="flex space-x-2 md:space-x-4 items-center">
            <li>
                <a
                    href="/"
                    class={`hover:text-red-500 font-semibold ${currentUrl === "/" ? "text-red-500" : ""} transition-all duration-300 text-sm md:text-base`}
                    >Inicio</a
                >
            </li>
            <li>
                <a
                    href="/products"
                    class={`hover:text-red-500 font-semibold ${currentUrl === "/products" ? "text-red-500" : ""} transition-all duration-300 text-sm md:text-base`}
                    >Productos</a
                >
            </li>
            <li>
                <a href="/cart" class="relative flex items-center group">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6 md:h-6 md:w-6"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13l-1.35 2.7A1 1 0 007.5 17h9a1 1 0 00.85-1.53L17 13M7 13V6a1 1 0 011-1h5a1 1 0 011 1v7"
                        ></path>
                    </svg>
                    <span
                        id="cart-count"
                        class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full text-xs w-5 h-5 flex items-center justify-center"
                        >0</span
                    >
                </a>
            </li>
            <li>
                {
                    isLoggedIn ? (
                        <form action="/api/auth/signout" method="get">
                            <button
                                type="submit"
                                class="hover:text-red-500 font-semibold transition-all duration-300 text-sm md:text-base bg-transparent border-none cursor-pointer"
                            >
                                Cerrar Sesi√≥n
                            </button>
                        </form>
                    ) : (
                        <a
                            href="/register"
                            class={`hover:text-red-500 font-semibold ${currentUrl === "/register" ? "text-red-500" : ""} transition-all duration-300 text-sm md:text-base`}
                        >
                            Registrarse
                        </a>
                    )
                }
            </li>
        </ul>
    </nav>
</header>

<style>
    @media (max-width: 768px) {
        header {
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }
        .md\:px-12 {
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }
        .md\:text-xl {
            font-size: 1.125rem !important;
        }
        .md\:h-6,
        .md\:w-6 {
            height: 1.5rem !important;
            width: 1.5rem !important;
        }
        .md\:text-base {
            font-size: 1rem !important;
        }
        ul.flex {
            gap: 0.5rem !important;
        }
    }
</style>

<script type="module">
    function getCart() {
        try {
            return JSON.parse(localStorage.getItem("cart") || "[]");
        } catch {
            return [];
        }
    }
    function updateCartCount() {
        const cart = getCart();
        const count = cart.reduce(
            (sum, item) => sum + (Number(item.Cantidad) || 0),
            0,
        );
        const badge = document.getElementById("cart-count");
        if (badge) badge.textContent = count;
    }
    window.updateCartCount = updateCartCount;
    updateCartCount();
    window.addEventListener("storage", function (e) {
        if (e.key === "cart") updateCartCount();
    });
</script>
